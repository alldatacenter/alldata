<!--
  ~ Copyright 2020 ABSA Group Limited
  ~
  ~ Licensed under the Apache License, Version 2.0 (the "License");
  ~ you may not use this file except in compliance with the License.
  ~ You may obtain a copy of the License at
  ~
  ~     http://www.apache.org/licenses/LICENSE-2.0
  ~
  ~ Unless required by applicable law or agreed to in writing, software
  ~ distributed under the License is distributed on an "AS IS" BASIS,
  ~ WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  ~ See the License for the specific language governing permissions and
  ~ limitations under the License.
  -->

<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css"
          integrity="sha384-9aIt2nRpC12Uk9gS9baDl411NQApFmC26EwAOH8WgZl5MYYxFfc+NcPb1dKGj7Sk" crossorigin="anonymous">

    <title>Spline REST Gateway</title>
</head>

<body>

<!-- HEADER -->
<nav class="navbar navbar-dark bg-dark">
    <a class="navbar-brand" href="#">
        <img src="https://absaoss.github.io/spline/assets/images/spline-logo-dark.png"
             height="30" class="d-inline-block align-top" alt="" loading="lazy">
    </a>
</nav>
<!-- ./HEADER -->

<br>

<!-- BODY -->
<div class="container">
    <div class="row row-cols-1 row-cols-md-2">

        <!-- CARD: GATEWAY INFO -->
        <div class="col mb-4">
            <div class="card h-100">
                <h5 class="card-header">Spline REST Gateway</h5>
                <div class="card-body">
                    <dl class="row">
                        <dt class="col-sm-4">Version</dt>
                        <dd class="col-sm-8">
                            <div id="spline-version">&nbsp;</div>
                            <h6 class="text-muted">
                                <small class="d-block"><span id="spline-timestamp" title="build date">&nbsp;</span></small>
                                <small class="d-block text-truncate"><span id="spline-revision" title="revision number">&nbsp;</span></small>
                            </h6>
                        </dd>

                        <dt class="col-sm-4">Status</dt>
                        <dd class="col-sm-8"><span class="badge badge-pill" id="spline-status">&nbsp;</span></dd>
                    </dl>
                </div>
            </div>
        </div>
        <!-- ./CARD: GATEWAY INFO -->

        <!-- CARD: DOCS -->
        <div class="col mb-4">
            <div class="card h-100">
                <h5 class="card-header">Documentation</h5>
                <div class="card-body">
                    <nav class="nav flex-column">
                        <a class="nav-link" rel="noopener noreferrer" href="https://absaoss.github.io/spline/" target="_blank">GitHub pages</a>
                        <a class="nav-link" rel="noopener noreferrer" href="docs/producer.html" target="_blank">Producer API specification</a>
                        <a class="nav-link" rel="noopener noreferrer" href="docs/consumer.html" target="_blank">Consumer API specification</a>
                    </nav>
                </div>
            </div>
        </div>
        <!-- ./CARD: DOCS -->

        <!-- CARD: PRODUCER CONF -->
        <div class="col mb-4">
            <div class="card h-100">
                <h5 class="card-header">Producer API</h5>
                <div class="card-body">
                    <dl class="row">
                        <dt class="col-sm-4">Base URL</dt>
                        <dd class="col-sm-8"><code id="spline-producer-url">&nbsp;</code></dd>

                        <dt class="col-sm-4">API version</dt>
                        <dd class="col-sm-8"><code id="spline-producer-api-version">&nbsp;</code></dd>

                        <dt class="col-sm-4">Request encoding</dt>
                        <dd class="col-sm-8"><code id="spline-producer-request-compression">&nbsp;</code></dd>
                    </dl>
                </div>
            </div>
        </div>
        <!-- ./CARD: PRODUCER CONF -->

        <!-- CARD: CONSUMER CONF -->
        <div class="col mb-4">
            <div class="card h-100">
                <h5 class="card-header">Consumer API</h5>
                <div class="card-body">
                    <dl class="row">
                        <dt class="col-sm-4">Base URL</dt>
                        <dd class="col-sm-8"><code id="spline-consumer-url">&nbsp;</code></dd>
                    </dl>
                </div>
            </div>
        </div>
        <!-- ./CARD: CONSUMER CONF -->

        <!-- CARD: DIAGNOSTICS API -->
        <div class="col mb-4">
            <div class="card h-100">
                <h5 class="card-header">Diagnostics API</h5>
                <div class="card-body">
                    <dl class="row">
                        <dt class="col-sm-4">Server version</dt>
                        <dd class="col-sm-8"><code id="spline-diagnostics-version-url">&nbsp;</code></dd>

                        <dt class="col-sm-4">Readiness probe</dt>
                        <dd class="col-sm-8"><code id="spline-diagnostics-readiness-url">&nbsp;</code></dd>

                        <dt class="col-sm-4">Liveness probe</dt>
                        <dd class="col-sm-8"><code id="spline-diagnostics-liveness-url">&nbsp;</code></dd>
                    </dl>
                </div>
            </div>
        </div>
        <!-- ./CARD: DIAGNOSTICS API -->

    </div>
</div>
<!-- ./BODY -->

</body>

<script src="https://code.jquery.com/jquery-3.5.1.min.js"
        integrity="sha384-ZvpUoO/+PpLXR1lu4jmpXWu80pZlYUAfxl5NsBMWOEPSjUn/6Z/hRTt8+pR6L4N2"
        crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"
        integrity="sha512-qTXRIMyZIFb8iQcfjXWCO8+M5Tbc38Qi5WzdPOYZHIlZpzBHG3L3by84BBBOiRGiEb7KKtAOAs5qYdUiZiQNNQ=="
        crossorigin="anonymous"></script>
<script>
    const baseUrl =
        document.location.origin +
        document.location.pathname
            .split("/")
            .filter(t => !t.endsWith(".html"))
            .join("/")

    document.querySelector('#spline-producer-url').textContent = `${baseUrl}/producer`
    document.querySelector('#spline-consumer-url').textContent = `${baseUrl}/consumer`
    document.querySelector('#spline-diagnostics-version-url').textContent = `${baseUrl}/about/version`
    document.querySelector('#spline-diagnostics-readiness-url').textContent = `${baseUrl}/about/readiness`
    document.querySelector('#spline-diagnostics-liveness-url').textContent = `${baseUrl}/about/liveness`

    update()
    setInterval(update, 5000)

    function update() {
        const OK = "badge-success"
        const WARN = "badge-secondary"
        const ERROR = "badge-warning"
        const FATAL = "badge-danger"
        const ALL = [OK, WARN, ERROR, FATAL]

        $.get(`${baseUrl}/about/version`)
            .done(data => {
                document.querySelector('#spline-version').textContent = data.build.version
                document.querySelector('#spline-revision').textContent = data.build.revision
                document.querySelector('#spline-timestamp').textContent = data.build.timestamp && moment(data.build.timestamp).format("ll")
            })

        $.ajax(`${baseUrl}/producer/status`, {method: 'HEAD'})
            .done((data, status, jqXHR) => {
                const headers = Object.fromEntries(
                    jqXHR.getAllResponseHeaders().split("\n").map(header => {
                        const tokens = header.split(": ")
                        const key = tokens.shift()
                        return [key.toLowerCase(), tokens]
                    }))

                document.querySelector('#spline-producer-request-compression').textContent = headers["absa-spline-accept-request-encoding"]
                document.querySelector('#spline-producer-api-version').textContent = headers["absa-spline-api-version"]

                const statusElem = document.querySelector('#spline-status')
                statusElem.classList.remove(...ALL)
                statusElem.classList.add(OK)
                statusElem.textContent = "Running"
            })
            .fail(jqXHR => {
                const code = jqXHR.status
                const [, badgeClass, message] = [
                    [code === 0, WARN, "Disconnected"],
                    [code === 404, FATAL, "Service not found"],
                    [code === 503, ERROR, "Not ready (check the database)"],
                    [true, FATAL, "Error"]
                ].find(([b]) => b)

                const statusElem = document.querySelector('#spline-status')
                statusElem.classList.remove(...ALL)
                statusElem.classList.add(badgeClass)
                statusElem.textContent = `${jqXHR.status} - ${message}`
            })
    }
</script>
</html>
